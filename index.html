<?php
session_start();
require 'config.php';

// Check kung naka-login ang staff
if (!isset($_SESSION['staff_logged_in']) || $_SESSION['staff_logged_in'] !== true) {
    header("Location: home.php");
    exit;
}

// Kunin ang MGA VISITORS from database
$visitors_result = $conn->query("SELECT * FROM visitors");
$visitors_data = [];
while($visitor = $visitors_result->fetch_assoc()) {
    $visitors_data[$visitor['unique_id']] = $visitor;
}

// Kunin ang mga access logs
$logs_result = $conn->query("
    SELECT al.*, v.contact, v.school, v.visit_date, v.purpose 
    FROM access_logs al 
    LEFT JOIN visitors v ON al.visitor_id = v.id 
    ORDER BY al.logged_at DESC 
    LIMIT 50
");
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- HEAD CONTENT SAME AS BEFORE -->
</head>
<body>

  <header>
    <i class="ri-qr-scan-2-line"></i> Staff Log Management
    <a href="logout.php" class="logout-btn">Logout</a>
  </header>

  <main>
    <div class="demo-notice">
      <strong>üìä Registered Visitors: <?php echo count($visitors_data); ?></strong>
    </div>

    <div id="reader"></div>
    <button class="btn" onclick="startScanner()">
      <i class="ri-camera-line"></i> Start Scanner
    </button>

    <!-- Visitor Info Display -->
    <div id="visitorInfo" class="visitor-info" style="display:none;">
      <h3>üìã Visitor Information</h3>
      <p><strong>Name:</strong> <span id="infoName"></span></p>
      <p><strong>Contact:</strong> <span id="infoContact"></span></p>
      <p><strong>School:</strong> <span id="infoSchool"></span></p>
      <p><strong>Purpose:</strong> <span id="infoPurpose"></span></p>
      <p><strong>Visit Date:</strong> <span id="infoDate"></span></p>
    </div>

    <h2>Recent Access Logs</h2>
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Visitor Name</th>
          <th>Contact</th>
          <th>School</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <?php if ($logs_result->num_rows > 0): ?>
          <?php while($log = $logs_result->fetch_assoc()): ?>
          <tr>
            <td><?= date('M j, g:i A', strtotime($log['logged_at'])) ?></td>
            <td><?= htmlspecialchars($log['fullname']) ?></td>
            <td><?= htmlspecialchars($log['contact']) ?></td>
            <td><?= htmlspecialchars($log['school']) ?></td>
            <td class="status-entry <?= $log['action'] ?>"><?= strtoupper($log['action']) ?></td>
          </tr>
          <?php endwhile; ?>
        <?php else: ?>
          <tr><td colspan="5">No access logs found</td></tr>
        <?php endif; ?>
      </tbody>
    </table>
  </main>

  <script>
  let html5QrcodeScanner;
  
  // VISITORS FROM DATABASE - Auto-loaded from PHP
  const visitorDatabase = <?php echo json_encode($visitors_data); ?>;

  async function startScanner() {
    const reader = document.getElementById("reader");
    reader.innerHTML = "";
    
    try {
      html5QrcodeScanner = new Html5Qrcode("reader");
      
      await html5QrcodeScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => handleScan(decodedText)
      );
    } catch (err) {
      alert("‚ö†Ô∏è Camera access denied or not supported.");
    }
  }

  function handleScan(decodedText) {
    if (html5QrcodeScanner) {
      html5QrcodeScanner.stop();
    }

    let visitorData;
    try {
      visitorData = JSON.parse(decodedText);
    } catch {
      // If plain text, lookup in database
      const scannedId = decodedText.trim();
      if (visitorDatabase[scannedId]) {
        visitorData = visitorDatabase[scannedId];
        visitorData.unique_id = scannedId;
      } else {
        alert("‚ùå Visitor not found: " + scannedId);
        return;
      }
    }

    // Send to server to log the scan
    fetch("api/scan_log.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        unique_id: visitorData.unique_id,
        fullname: visitorData.fullname 
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // Show visitor info
        document.getElementById('visitorInfo').style.display = 'block';
        document.getElementById('infoName').textContent = visitorData.fullname;
        document.getElementById('infoContact').textContent = visitorData.contact;
        document.getElementById('infoSchool').textContent = visitorData.school;
        document.getElementById('infoPurpose').textContent = visitorData.purpose;
        document.getElementById('infoDate').textContent = visitorData.visit_date;
        
        alert("‚úÖ " + data.message + " - " + visitorData.fullname);
        setTimeout(() => location.reload(), 1500);
      } else {
        alert("‚ùå " + data.message);
      }
    });
  }
  </script>
</body>
</html>
